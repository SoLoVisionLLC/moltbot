###############################################################################
# Moltbot Coolify Deployment
#
# IMPORTANT: Keep this file in a SEPARATE private repo, not in your Moltbot fork.
# This keeps your fork clean for upstream updates.
#
# Usage in Coolify:
# 1. Create a new service from this docker-compose file
# 2. Set environment variables in Coolify's UI (see below)
# 3. Coolify will handle volumes automatically
###############################################################################

services:
  moltbot:
    # Option 1: Build from your fork (recommended for staying updated)
    build:
      context: https://github.com/YOUR_USERNAME/moltbot.git#main
      dockerfile: Dockerfile
      args:
        # Uncomment to add extra packages (e.g., ffmpeg for media processing)
        # CLAWDBOT_DOCKER_APT_PACKAGES: "ffmpeg"

    # Option 2: Use a pre-built image (comment out 'build' section above)
    # image: ghcr.io/your-username/moltbot:latest

    ports:
      - "18789:18789"    # Gateway HTTP/WebSocket (required)
      # - "18790:18790"  # Bridge port (optional, for advanced setups)

    volumes:
      - moltbot-config:/home/node/.clawdbot      # Config, sessions, credentials
      - moltbot-workspace:/home/node/clawd       # Agent workspace

    environment:
      # === REQUIRED ===
      NODE_ENV: production
      HOME: /home/node
      TERM: xterm-256color

      # Gateway authentication (CHANGE THIS - generate a secure random token)
      CLAWDBOT_GATEWAY_TOKEN: ${GATEWAY_TOKEN:?Set GATEWAY_TOKEN in Coolify}

      # === MODEL PROVIDER (choose one) ===
      # OpenRouter (recommended)
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}

      # Or Anthropic direct
      # ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # Or OpenAI
      # OPENAI_API_KEY: ${OPENAI_API_KEY:-}

      # === CHANNELS (configure as needed) ===
      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}

      # Discord
      # DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}

      # WhatsApp (uses QR pairing, no token needed)

      # === OPTIONAL SERVICES ===
      # Claude.ai session (for Claude web features)
      # CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      # CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      # CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}

      # Brave Search (for web_search tool)
      # BRAVE_API_KEY: ${BRAVE_API_KEY:-}

    command:
      - node
      - dist/index.js
      - gateway
      - --bind
      - lan
      - --port
      - "18789"

    # Health check for Coolify monitoring
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    init: true
    restart: unless-stopped

    # Resource limits (adjust based on your Coolify server)
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

volumes:
  moltbot-config:
    # Persistent storage for config, sessions, and credentials
    # Coolify will create and manage this volume
  moltbot-workspace:
    # Persistent storage for agent workspace files
    # Coolify will create and manage this volume

###############################################################################
# COOLIFY ENVIRONMENT VARIABLES
# Set these in Coolify's UI under Environment Variables:
#
# Required:
#   GATEWAY_TOKEN          - Secure random token (generate with: openssl rand -hex 32)
#   OPENROUTER_API_KEY     - Your OpenRouter API key (from openrouter.ai/keys)
#
# Optional (channels):
#   TELEGRAM_BOT_TOKEN     - From @BotFather
#   DISCORD_BOT_TOKEN      - From Discord Developer Portal
#
# Optional (services):
#   BRAVE_API_KEY          - For web search capability
#
###############################################################################
# FIRST-TIME SETUP
#
# After deployment, you need to configure channels. Two options:
#
# Option A: SSH into container via Coolify terminal
#   node dist/index.js configure
#
# Option B: Pre-create config file
#   Create moltbot.json and mount it, or copy into the moltbot-config volume
#
# Example moltbot.json:
# {
#   "gateway": {
#     "port": 18789,
#     "bind": "lan",
#     "auth": { "mode": "token" }
#   },
#   "channels": {
#     "telegram": {
#       "token": "${TELEGRAM_BOT_TOKEN}",
#       "allowFrom": ["YOUR_TELEGRAM_USER_ID"]
#     }
#   },
#   "default_model": "openrouter/anthropic/claude-opus-4.5"
# }
###############################################################################
